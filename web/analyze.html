<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gollora - Analysis Dashboard</title>
    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --border-color: #e1e4e8;
            --background-color: #f6f8fa;
            --text-color: #24292e;
            --primary-button-bg: #2ea44f;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        #input-area { display: flex; gap: 10px; margin-bottom: 20px; }
        #input-area input { flex-grow: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; }
        #input-area button { padding: 12px 20px; font-size: 16px; background-color: var(--primary-button-bg); color: white; border: none; border-radius: 6px; cursor: pointer; }
        #input-area button:disabled { background-color: #94d3a2; cursor: not-allowed; }
        
        #dashboard { display: none; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        #status-log { background-color: #24292e; color: #c9d1d9; font-family: 'SF Mono', monospace; font-size: 13px; padding: 15px; border-radius: 6px; overflow-y: auto; max-height: 25vh; white-space: pre-wrap; margin-bottom: 20px; }
        #results-area { background: #fff; border: 1px solid var(--border-color); border-radius: 6px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        /* Markdown styles */
        #results-area h1, #results-area h2, #results-area h3 { border-bottom: 1px solid var(--border-color); padding-bottom: .3em; }
        #results-area table { border-collapse: collapse; width: 100%; }
        #results-area th, #results-area td { border: 1px solid #dfe2e5; padding: 6px 13px; }
        #results-area pre { background-color: #f6f8fa; padding: 16px; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>On-Demand Analysis Dashboard</h1></div>
        <div id="input-area">
            <input type="text" id="repo-url" placeholder="Enter GitHub Repository URL..." autocomplete="off">
            <button id="analyze-button">Analyze</button>
        </div>
        
        <div id="dashboard">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Issues by Severity</h3>
                    <canvas id="severityChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Issues by Language</h3>
                    <canvas id="languageChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>File Hotspots (Top 5)</h3>
                    <canvas id="hotspotChart"></canvas>
                </div>
            </div>
        </div>

        <h3>Status Log</h3>
        <pre id="status-log">Awaiting repository URL...</pre>
        <h3>Analysis Report</h3>
        <div id="results-area" style="display: none;"></div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: false });

        const repoUrlInput = document.getElementById('repo-url');
        const analyzeButton = document.getElementById('analyze-button');
        const statusLog = document.getElementById('status-log');
        const resultsArea = document.getElementById('results-area');
        const dashboard = document.getElementById('dashboard');

        let severityChart, languageChart, hotspotChart;

        function logStatus(text) {
            statusLog.textContent += text + '\n';
            statusLog.scrollTop = statusLog.scrollHeight;
        }

        function createChart(ctx, type, data, options) {
            return new Chart(ctx, { type, data, options });
        }

        function renderDashboard(summary) {
            dashboard.style.display = 'block';

            // Severity Chart (Pie)
            if (severityChart) severityChart.destroy();
            const severityData = {
                labels: ['Critical', 'Error', 'Warning', 'Info'],
                datasets: [{
                    data: [summary.critical_count, summary.error_count, summary.warning_count, summary.info_count],
                    backgroundColor: ['#d73a49', '#cb2431', '#f9c513', '#0366d6']
                }]
            };
            severityChart = createChart(document.getElementById('severityChart').getContext('2d'), 'pie', severityData);

            // Language Chart (Doughnut)
            if (languageChart) languageChart.destroy();
            const langLabels = Object.keys(summary.issues_by_language);
            const langData = {
                labels: langLabels,
                datasets: [{ data: Object.values(summary.issues_by_language) }]
            };
            languageChart = createChart(document.getElementById('languageChart').getContext('2d'), 'doughnut', langData);

            // Hotspot Chart (Bar)
            if (hotspotChart) hotspotChart.destroy();
            const fileIssues = Object.entries(summary.issues_by_file).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const hotspotData = {
                labels: fileIssues.map(item => item[0]),
                datasets: [{
                    label: 'Issues',
                    data: fileIssues.map(item => item[1]),
                    backgroundColor: '#28a745'
                }]
            };
            hotspotChart = createChart(document.getElementById('hotspotChart').getContext('2d'), 'bar', hotspotData, { indexAxis: 'y' });
        }

        analyzeButton.addEventListener('click', () => {
            const repoUrl = repoUrlInput.value.trim();
            if (!repoUrl) return;

            repoUrlInput.disabled = true;
            analyzeButton.disabled = true;
            statusLog.textContent = '';
            resultsArea.style.display = 'none';
            resultsArea.innerHTML = '';

            logStatus(`Connecting to agent for analyzing: ${repoUrl}`);
            
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${wsProtocol}//${window.location.host}/analyze/ws`);

            socket.onopen = () => {
                socket.send(JSON.stringify({ type: 'init', url: repoUrl }));
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case 'status':
                        logStatus(data.message);
                        break;
                    case 'result':
                        logStatus('Analysis complete! Displaying results.');
                        
                        // The backend now sends the full JSON result object
                        const result = JSON.parse(data.message);
                        
                        // Render dashboard
                        renderDashboard(result.summary);

                        // Generate and render markdown
                        generateMarkdown(result).then(markdown => {
                            resultsArea.style.display = 'block';
                            resultsArea.innerHTML = marked.parse(markdown);
                            mermaid.run({ nodes: resultsArea.querySelectorAll('.mermaid') });
                        });

                        repoUrlInput.disabled = false;
                        analyzeButton.disabled = false;
                        break;
                    case 'error':
                        logStatus(`Error: ${data.message}`);
                        repoUrlInput.disabled = false;
                        analyzeButton.disabled = false;
                        break;
                }
            };

            socket.onclose = () => {
                logStatus('Connection closed.');
                if (repoUrlInput.disabled) {
                    repoUrlInput.disabled = false;
                    analyzeButton.disabled = false;
                }
            };
        });

        // New function to generate markdown on the client side from the JSON result
        async function generateMarkdown(result) {
            let md = `# Code Review Report\n\n## Summary\n\n`;
            md += `| Metric | Value |\n|---|---|\n`;
            for (const [key, value] of Object.entries(result.summary)) {
                if (key !== 'dependency_graph') {
                    md += `| ${key.replace(/_/g, ' ')} | ${value} |\n`;
                }
            }

            if (result.summary.dependency_graph) {
                md += `\n## Dependency Graph\n\n\`\`\`mermaid\n${result.summary.dependency_graph}\n\`\`\`\n`;
            }

            md += `\n## Findings\n\n`;
            result.issues.forEach((issue, index) => {
                md += `### ${index + 1}. ${issue.title}\n\n`;
                md += `**Severity**: ${issue.severity}  \n`;
                md += `**File**: \`${issue.file}:${issue.line}\`  \n`;
                md += `**Description**: ${issue.description}\n\n`;
                if (issue.fix) {
                    md += `**Suggested Fix**:\n\`\`\`\n${issue.fix}\n\`\`\`\n\n`;
                }
            });
            return md;
        }
    </script>
</body>
</html>